
1# Домашнее задание к занятию «Микросервисы: принципы»

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

## Задача 1: API Gateway 

Предложите решение для обеспечения реализации API Gateway. Составьте сравнительную таблицу возможностей различных программных решений. На основе таблицы сделайте выбор решения.

Решение должно соответствовать следующим требованиям:
- маршрутизация запросов к нужному сервису на основе конфигурации,
- возможность проверки аутентификационной информации в запросах,
- обеспечение терминации HTTPS.

Обоснуйте свой выбор.

## Ответ:

| Решение       | Маршрутизация запросов     | Проверка аутентификации в запросах                         | Терминация HTTPS |
| ------------- |:--------------------------:| ----------------------------------------------------------:|-----------------:|
| Azure API     |  Azure API поддерживает новый тип маршрутизации, называемый маршрутизацией атрибутов. Как следует из названия, маршрутизация атрибутов использует атрибуты для определения маршрутов. Маршрутизация атрибутов обеспечивает больший контроль над URI в веб-API. Например, можно легко создавать URI, описывающие иерархии ресурсов. Предыдущий стиль маршрутизации, называемый маршрутизацией на основе соглашений, по-прежнему полностью поддерживается. | Каждый вызов REST API, отправляемый в приложение IoT Central, должен включать заголовок авторизации. Заголовок Authorization должен содержать маркер API или маркер носителя AAD. Эти маркеры используются IoT Central для определения того, кто является вызывающим и к чему он имеет доступ в приложении.| Шлюз приложений поддерживает завершение сеансов TLS на шлюзе, после чего трафик обычно передается в незашифрованном виде на внутренние серверы. Завершение сеансов TLS на шлюзе приложений дает ряд преимуществ: Улучшенная производительность, Более эффективное использование внутренних серверов, Интеллектуальная маршрутизация, Управление сертификатами |
| nginx         | Маршрутизация запросов настраивается через location. Необходимо использовать регулярное выражение для определения микросервиса, на который будет направлен запрос | NGINX обладает возможностью выполнять аутентификацию клиентов. Запросы аутентификации клиента при помощи NGINX разгружает работу и предоставляет возможность прекращать попадание на ваши серверы запросов без аутентификации. Доступные для NGINX с открытым исходным кодом модули включают базовую аутентификацию и подзапросы аутентификации. Имеющийся исключительно в NGINX Plus модуль проверки JWT (JSON Web Tokens) делает возможной интеграцию со сторонними производителями аутентификации, которые применяют стандарт OpenID Connect. |Nginx можно настроить как балансировщик нагрузки, что позволяет распределять входящий трафик между несколькими внутренними серверами. SSL-терминация является процессом на балансировщике нагрузки, который обрабатывает шифрование и дешифровку SSL таким образом, чтобы трафик между балансировщиком и внутренними серверами был в HTTP. Серверы на бэкэнде должны  быть защищены путем ограничения доступа к IP балансировщика нагрузки |
| haproxy       | В разделе frontend конфига haproxy мы можем настроить несколько директив. Директива «bind» используется для указания того, какой порт HAProxy будет прослушивать. Директивы «acl» определяют критерии для маршрутизации входящего трафика. Первый параметр, следующий за директивой, является просто внутренним именем для будущей ссылки, а остальные параметры определяют методы, используемые для сопоставления некоторого элемента входящего запроса, который используется в качестве основы для маршрутизации | Haproxy поддерживает Basic Authentication, Client Certificate Authentication, JSON Web Token-Based Authorization | Haproxy поддерживает ssl-терминацию для запросов к микросервисам, для этого нужно настроить сертификат SSL на самом Haproxy. Также haproxy поддерживает ssl verify none — терминацию SSL-сертификата, игнорирующая ошибки |

Я предлагаю воспользоваться решением haproxy. HAProxy активно используется в различных высоконагруженных веб-сайтах, таких как Instagram, Twitter, Reddit и т.д. К числу его основных функций можно отнести:

- Бесплатное решение
- Балансировка HTTP и TCP соединений
- Маршрутизация запросов
- Возможность перезапуска без потери активных соединений
- Встроенный веб-интерфейс для просмотра статистики с HTTP basic аутентификацией
- Возможность аутентификации запросов по сертификату и токену
- Возможность терминировать SSL (можно ставить перед веб-приложениями вместо nginx)


## Задача 2: Брокер сообщений

Составьте таблицу возможностей различных брокеров сообщений. На основе таблицы сделайте обоснованный выбор решения.

Решение должно соответствовать следующим требованиям:
- поддержка кластеризации для обеспечения надёжности,
- хранение сообщений на диске в процессе доставки,
- высокая скорость работы,
- поддержка различных форматов сообщений,
- разделение прав доступа к различным потокам сообщений,
- простота эксплуатации.

Обоснуйте свой выбор.

## Ответ

| Решение       | поддержка кластеризации для обеспечения надёжности | хранение сообщений на диске в процессе доставки | высокая скорость работы | поддержка различных форматов сообщений | разделение прав доступа к различным потокам сообщений | простота эксплуатации |
| ------------- |:--------------------------:| ----------------------------------------------------------:|-----------------:|-----------------:|-----------------:|-----------------:|
| kafka     | Распределенность Kafka заключается в том, что хранение, получение и рассылка сообщений у него организовано на разных узлах (так называемых «брокерах»). Важнейшие плюсы такого подхода – высокодоступность и отказоустойчивость | Хранение данных на диске в течение длительного времени позволяет не беспокоится о потере данных при резком росте нагрузки. Кафка, будучи своего рода буфером, компенсирует отставание потребителей, позволяя накапливать в себе сообщения до нормализации нагрузки или масштабирования консьюмеров. Также обеспечивается гибкая конфигурация, где отдельные потоки данных (топики) хранятся на диске с разным сроком | Kafka обладает такими ценными качествами, как скорость работы, масштабируемость, способность секционировать и множество раз фиксировать одни и те же данные в памяти | Kafka поддерживает не только JSON, но и другие форматы сообщений: бинарные Apache AVRO и Protobuf, текст и т.д. В любом случае, какой бы формат данных не был у исходного сообщения, в топике оно хранится в виде набора байтов. | ACL-авторизация: после проверки подлинности клиентов брокеры Kafka обращаются к спискам управления доступом (ACL, Access Control Lists), чтобы определить, допущен (авторизован) ли конкретный клиент на запись или чтение в какой-либо топик. | kafka сложна в освоении и эксплуатации |
| RabbitMQ | Кластер, в rabbitMQ, это связь одного и более серверов RabbitMQ друг с другом, в которой один из узлов выступает в роли мастер-сервера, остальные в роли слейв-серверов, на мастере задаются настройки кластера, которые дублируются на слейвы, к ним, в частности, относятся настройки доступа и политик. При падении мастера, один из слейвов берет на себя его роль, и становится мастером | Опционально. В RabbitMQ тоже есть механизмы подтверждения и репликации, а также возможность записывать сообщения на диск вместо хранения в оперативной памяти. Для этого при создании очереди ей следует установить тип Durable вместо Transient. Это гарантирует, что сообщения не будут потеряны при перезапуске брокера. | Производительность RabbitMQ не превышает десятки тысяч сообщений в секунду. Это хороший результат для многих применений, но совершенно неудовлетворительный для высоконагруженных систем | It is possible for messages to contain only attributes and no payload. It is common to use serialisation formats like JSON, Thrift, Protocol Buffers and MessagePack to serialize structured data in order to publish it as the message payload. | Пользователи могут быть добавлены из интерфейса управления, и каждому пользователю могут быть назначены права, такие как права на чтение, запись и настройку привилегий. Пользователям также могут быть назначены права для конкретных виртуальных хостов. | RabbitMQ проще в своей структуре и потребует, зачастую, меньше времени на погружение в себя разработчиков и вызовет меньше затрат на проектирование и отладку |

Из того, что мы рассмотрели выше, можно сделать вывод, что Kafka более гибкая технология, хорошо приспособленная для построения распределенных систем с высокой отказоустойчивостью. При этом даже из кратких описаний двух брокеров сообщений можно делать вывод, что RabbitMQ проще в своей структуре и потребует, зачастую, меньше времени на погружение в себя разработчиков и вызовет меньше затрат на проектирование и отладку. 
Я предлагаю выбрать kafka, как более гибкое и отказоустойчивое решение с большей производительностью.

## Задача 3: API Gateway * (необязательная)

### Есть три сервиса:

**minio**
- хранит загруженные файлы в бакете images,
- S3 протокол,

**uploader**
- принимает файл, если картинка сжимает и загружает его в minio,
- POST /v1/upload,

**security**
- регистрация пользователя POST /v1/user,
- получение информации о пользователе GET /v1/user,
- логин пользователя POST /v1/token,
- проверка токена GET /v1/token/validation.

### Необходимо воспользоваться любым балансировщиком и сделать API Gateway:

**POST /v1/register**
1. Анонимный доступ.
2. Запрос направляется в сервис security POST /v1/user.

**POST /v1/token**
1. Анонимный доступ.
2. Запрос направляется в сервис security POST /v1/token.

**GET /v1/user**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис security GET /v1/user.

**POST /v1/upload**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис uploader POST /v1/upload.

**GET /v1/user/{image}**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис minio GET /images/{image}.

### Ожидаемый результат

Результатом выполнения задачи должен быть docker compose файл, запустив который можно локально выполнить следующие команды с успешным результатом.
Предполагается, что для реализации API Gateway будет написан конфиг для NGinx или другого балансировщика нагрузки, который будет запущен как сервис через docker-compose и будет обеспечивать балансировку и проверку аутентификации входящих запросов.
Авторизация
curl -X POST -H 'Content-Type: application/json' -d '{"login":"bob", "password":"qwe123"}' http://localhost/token

**Загрузка файла**

curl -X POST -H 'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJib2IifQ.hiMVLmssoTsy1MqbmIoviDeFPvo-nCd92d4UFiN2O2I' -H 'Content-Type: octet/stream' --data-binary @yourfilename.jpg http://localhost/upload

**Получение файла**
curl -X GET http://localhost/images/4e6df220-295e-4231-82bc-45e4b1484430.jpg

---

#### [Дополнительные материалы: как запускать, как тестировать, как проверить](https://github.com/netology-code/devkub-homeworks/tree/main/11-microservices-02-principles)

---

### Как оформить ДЗ?

Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

---
